# 再生画面 仕様書（最新版ドラフト / Swift + SwiftUI 前提）

## 0. 設計方針（最優先要件）
- 本機能は **別画面遷移（Push/Modal/別ウィンドウ）を増やさず**、同一画面内の状態切替で実現する。
- 操作は **連続性（シームレスな切替）** を重視し、状態切替は **スナップ＋アニメーション**で表現する。
- 歌詞表示とキュー表示は **排他** とする。
- 実装は **Swift + SwiftUI** を前提とする。

---

## 1. 用語定義

### 1.1 縮小楽曲情報（Compact Track Info）
- サムネイル＋タイトルの横並び表示。
- 高さ：**固定 48pt**
- 歌詞モードでは上部固定として扱う。
- キューモードでは **リスト内要素としてスクロール**する（ただし初期位置はSnap Bで上端に配置される）。

### 1.2 コントロール部（Controls）
以下を含む領域：
- 音量バー
- 再生ボタン
- スキップボタン
- シークバー
- 歌詞ボタン
- AirPlayボタン
- キューボタン

### 1.3 表示エリア小 / 表示エリア大（Small / Large）
- **2段階のみ（小/大の2状態、連続中間なし）**。  
- 原則として「小＝コントロール部表示」「大＝コントロール部非表示」で定義する。
- ただし **キューモード（S3）では「小/大」とは別概念として、S3内部にスクロールアンカー（Snap A/B）とフェーズ（Phase）を持つ**（6章）。  
  ※Snap A/B は **S3内のスクロール位置制御**であり、S3（小）⇄S4（大）の状態切替とは別。

---

## 2. 状態（State）一覧
本画面は以下の状態を持つ。

### 2.1 標準系
- **S0: 標準状態（現行）**  
  - 現在実装されている再生画面そのまま。

### 2.2 歌詞系（小/大）
- **S1: 縮小＋歌詞（小）**  
  - 上部：縮小楽曲情報（48pt・固定）  
  - 中央：歌詞（表示エリア小）  
  - 下部：コントロール部（表示）
- **S2: 縮小＋歌詞（大）**  
  - 上部：縮小楽曲情報（48pt・固定）  
  - 全体：歌詞（表示エリア大）  
  - コントロール部：非表示

### 2.3 キュー系（小/並び替え大）
- **S3: 縮小＋キュー（小）**  
  - コントロール部：表示（下部固定）  
  - 表示エリア小：**コントロール部より上の領域全体**  
  - キューは1つの縦構造を持つ（履歴→縮小楽曲情報→キューコントロール→現在のキュー）  
  - スクロール挙動は「Snap A/B＋Phase」で定義（6章）
- **S4: 縮小＋キュー並び替え（大）**  
  - コントロール部：非表示  
  - 表示エリア大：画面全体  
  - 並び替え開始で遷移、終了で必ずS3へ戻る（例外なし）

---

## 3. 状態遷移（Trigger / Transition）

### 3.1 標準 ↔ 縮小（歌詞/キュー）
- **S0 → S1**：歌詞ボタン押下
- **S0 → S3**：キューボタン押下

- **S1/S2 → S0**：歌詞ボタン再押下（トグル）
- **S3/S4 → S0**：キューボタン再押下（トグル）
- **S1/S2/S3/S4 → S0**：縮小サムネイルをタップ（縮小楽曲情報が表示されている場合）

※歌詞/キューは排他。縮小状態への入口/出口はモードボタンのトグルとサムネイルタップで定義する。

### 3.2 歌詞：小 ↔ 大（2段階スナップ）
- **S1 → S2**：歌詞の下方向スクロール/フリックで大へ
- **S2 → S1**：上方向スクロールで小へ
- スナップ：指を離した位置で近いスナップへ吸着（アニメーションあり）

#### ジェスチャ衝突（歌詞）
- 通常スクロールと大遷移の衝突を避けるため、**歌詞が上端付近のときのみ下方向ジェスチャでS2へ遷移**を許可する（閾値は実装調整可）。

### 3.3 キュー：小 ↔ 並び替え（大）
- **S3 → S4**：現在のキューで並び替え開始（Reorder handleドラッグ開始）
- **S4 → S3**：並び替え終了（指を離す）  
  - 例外なし（必ず小に戻る）
- 並び替え中の挙動は **iOS標準**に準拠。

---

## 4. レイアウト要件

### 4.1 歌詞（S1/S2）
- 縮小楽曲情報（48pt）は **上部固定**
- S1：表示エリア小＝縮小楽曲情報下〜コントロール部上
- S2：表示エリア大＝縮小楽曲情報下〜画面下端（コントロール部非表示）

### 4.2 キュー（S3/S4）
- **S3**：表示エリア小＝コントロール部より上の全領域（スクロール可能領域）  
  - 縮小楽曲情報はリスト内要素としてスクロールする  
  - ただし初期位置は Snap B（縮小楽曲情報が上端）で開始する（6章）
- **S4**：表示エリア大＝画面全体（コントロール部非表示）

---

## 5. 歌詞仕様
- 表示内容：歌詞
- 未取得時：**プレースホルダー**を表示
- 歌詞とキューは同時表示しない（排他）
- 小/大切替：3.2に従う

---

## 6. キュー仕様（スクロール挙動の確定版）

### 6.1 構造（上→下、順序固定）
1) 履歴（History）  
2) 縮小楽曲情報（CompactTrackInfo）  
3) キューコントロール（QueueControls）  
4) 現在のキュー（CurrentQueue）

補足：
- 縮小楽曲情報は **固定ヘッダではなくリスト内要素**
- QueueControls は **常時可視（上端固定＝sticky）**
- 現在のキューは「リスト内のリスト」としてスクロール開始する（後述）

### 6.2 初期位置（重要）
- **S0 → S3（キュー画面へ遷移）するたび**、初期位置は **Snap B** とする。  
  すなわち **縮小楽曲情報がリスト上端**に揃った位置から開始する。

（SwiftUI実装では `onAppear` 等で `scrollTo(compactAnchor, anchor: .top)` を行う）

### 6.3 スナップ点（Anchors）
キュー画面（S3）内の段階的な戻り/進みは、以下2点のスナップ点で定義する。

#### Snap A（履歴ゲート位置）
- 条件：**履歴セクションの下端が viewport 下端に一致**  
  `historyBottom == viewportBottom`

#### Snap B（メイン位置 / 初期位置）
- 条件：**縮小楽曲情報の上端が viewport 上端に一致**  
  `compactTop == viewportTop`

### 6.4 フェーズ（スクロール所有権の切替）
キュー画面（S3）では、外側スクロール（全体）と内側スクロール（CurrentQueue）の“所有権”が切り替わる。

#### Phase M（Main：Snap B基準）
- Snap B 付近の通常領域。
- `QueueControls` が viewport 上端に到達するまでは **外側スクロール**が進行。
- `QueueControls` が上端に到達した時点で：
  - QueueControls は **sticky（上端固定）**
  - **CurrentQueue が内側スクロール**として進行開始（リスト内のリスト）
  - 外側スクロールはロックされる（または実質進行しない）

- **逆方向（上方向）への復帰**：  
  - CurrentQueue の内側スクロールが上端にあり、かつ上方向スクロールが継続した場合、外側スクロールのロックを解除し、通常の外側スクロールへ所有権を戻す（履歴へ戻れること）。

> 実装指針：`LazyVStack(pinnedViews: [.sectionHeaders])` を用い、QueueControls を `Section(header:)` としてピン留めし、ピン留め開始以降は `outer.scrollDisabled(true)` / `inner.scrollDisabled(false)` に切替。逆方向復帰時はこの切替を反転する。

#### Phase H（History：履歴閲覧）
- ユーザーが上方向へスクロールして履歴へ入った領域。
- 履歴から下方向へ戻る動作には「履歴ゲート（6.5）」を適用する。

### 6.5 履歴ゲート（“見えるがそのままスクロールしない”＋スナップバック）
Phase H（履歴閲覧中）で履歴の下端へ到達した後、下方向へ操作した場合：

1) **履歴下端より下の要素（縮小楽曲情報以降）が覗ける**ことは許可する。  
2) ただし、閾値未満の操作では、ドラッグ終了時点で **Snap A にスナップバック**する。  
   - “そのままスクロールはしない”をこれで表現する。
3) 閾値を超えた場合のみ、**Snap B へアニメーションスナップ**してメイン領域へ復帰する。

#### 閾値の定義（仕様）
- 閾値は **距離ベース**（推奨）とし、数値は実装で調整可能とする。  
- 例：`(viewportBottom - historyBottom) > T` で Snap B へ遷移  
  - 速度ベースは採用しない（体感差が出やすい）

### 6.6 履歴（History）
- 定義：現行実装に準拠（既存挙動を踏襲）
- 操作：**全消去のみ**

### 6.7 キューコントロール（QueueControls）
- ボタン：シャッフル、リピート
- リピート状態（3状態）：
  1) リピート無し  
  2) 今の曲をリピート  
  3) キュー全体をリピート
- 表示：常時可視（sticky）。Phase Mで上端到達後は上端固定。

### 6.8 現在のキュー（CurrentQueue）
- 現在再生中の曲は含めない（縮小楽曲情報のみで表現）
- ラベルに追加元を付記（具体名まで）  
  例：`再生元: アルバム1`
- 操作：
  - 左スワイプ削除：確認なし（即時削除）
  - 並び替え：常に可能（Reorder handle）
  - 並び替え開始→S4（大）へ（アニメーション）
  - 指を離す→S3（小）へ戻る（例外なし）

### 6.9 状態表示
- シャッフル/リピート状態は **キューボタンに小さなアイコン**で表示する。

### 6.10 空状態
- キュー空：`キューが空です`
- 履歴空：空表示（セクションは表示）

---

## 7. アニメーション要件
- 状態遷移（S0↔縮小、歌詞小↔大、キュー小↔並び替え大、Snap A/B遷移）は **アニメーションあり**。
- スナップは「指を離した位置で近いスナップへ吸着」を基本とする（ただし履歴ゲートは閾値条件を優先）。
- スナップ閾値（距離T等）は実装調整可。ただし誤爆や違和感が目立たないことを必須とする。

---

## 8. 受入条件（主要シナリオ）
1) 標準で歌詞ボタン→S1、歌詞ボタン再押下→標準へ戻る。  
2) S1で歌詞上端付近から下フリック→S2、上スクロールでS1に戻る。  
3) 標準でキューボタン→S3。**初期位置がSnap B**（縮小楽曲情報が上端）である。  
4) S3で上にスクロールして履歴を閲覧、履歴下端付近で下方向操作：  
   - 閾値未満：Snap Aへ戻される（覗き見はできるが確定進行しない）  
   - 閾値超：Snap Bへスナップしてメインへ復帰  
5) S3でQueueControlsが上端到達後、QueueControlsは常時可視のまま、CurrentQueueが内側スクロールとして進行する。  
   - さらに、CurrentQueueが上端の状態で上方向スクロールを継続すると、外側スクロールへ所有権が戻り、履歴へ戻れる。  
6) 並び替え開始→S4、ドロップ→S3へ必ず戻る（例外なし）。  
7) キュー空で「キューが空です」、歌詞未取得でプレースホルダー。

---

## 9. 実装指針（SwiftUI前提・拘束）
- キュー画面の sticky + nested scroll は、以下の構成を推奨：
  - `ScrollView + LazyVStack(pinnedViews: [.sectionHeaders])`
  - `QueueControls` を `Section(header:)` としてピン留め（常時可視）
  - `CurrentQueue` を内側 `ScrollView` とし、ピン留め開始点で outer/inner の `scrollDisabled` を切替（逆方向復帰時は反転）
- Snap A/B 判定には Geometry + PreferenceKey 等で以下の座標を取得する：
  - `historyBottomY`, `compactTopY`, `viewportTopY`, `viewportBottomY`, `controlsTopY`
- 初期位置 Snap B は `onAppear` 等で `scrollTo(compactAnchor, anchor: .top)` を実行して保証する。

---

## 注記（用語統一）
- 「縮小歌詞情報」という表現が出てきた場合は「縮小楽曲情報」の誤記として扱い、用語は **縮小楽曲情報**に統一する。
